{# templates/_chatbot.html.twig #}

{# --- 1. LE BOUTON FLOTTANT (Toujours visible) --- #}
<div class="fixed bottom-6 right-6 z-50">
    {# Le cercle anim√© derri√®re pour l'effet "Pulse" #}
    <div class="absolute inset-0 rounded-full bg-primary opacity-75 animate-ping"></div>
    
    <button onclick="toggleChat()" class="relative btn btn-circle btn-primary btn-lg shadow-lg border-2 border-white/20 hover:scale-110 transition-transform duration-300">
        {# Ic√¥ne de Robot ou Bulle #}
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
        </svg>
    </button>
</div>

{# --- 2. LA FEN√äTRE DE CHAT (Cach√©e par d√©faut) --- #}
<div id="chat-window" class="fixed bottom-24 right-6 z-50 w-[90vw] sm:w-80 md:w-96 transform scale-0 origin-bottom-right transition-transform duration-300 ease-in-out">
    
    <div class="card bg-base-100/90 backdrop-blur-md border border-primary/30 shadow-2xl overflow-hidden">
        
        {# En-t√™te du Chat #}
        <div class="bg-primary/20 p-4 flex justify-between items-center border-b border-primary/10">
            <div class="flex items-center gap-3">
                <div class="avatar online">
                    <div class="w-10 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                        {# On utilise ton image de robot si elle existe, sinon une image par d√©faut #}
                        <img src="{{ asset('img/robot.jpg.png') }}" alt="Bot Avatar" />
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-sm">Crea'Bot </h3>
                    <p class="text-xs text-base-content/60">Assistant Virtuel</p>
                </div>
            </div>
            <button onclick="toggleChat()" class="btn btn-ghost btn-xs btn-circle text-base-content/50 hover:text-error">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>

        {# Zone des Messages #}
        <div id="chat-messages" class="p-4 h-80 overflow-y-auto space-y-4 bg-gradient-to-b from-base-100 to-base-200 scrollbar-thin scrollbar-thumb-primary scrollbar-track-base-200">
            
            {# Message du Robot (Statique pour l'instant) #}
            <div class="chat chat-start">
                <div class="chat-image avatar">
                    <div class="w-8 rounded-full">
                        <img src="{{ asset('img/robot.jpg.png') }}" />
                    </div>
                </div>
                <div class="chat-bubble chat-bubble-primary text-sm shadow-md">
                    Bonjour !  <br>Je suis SPARK l'IA de Cr√©a'Tech. Comment puis-je vous aider aujourd'hui ?
                </div>
            </div>

            {# Suggestions (R√©ponses rapides) #}
            <div class="flex flex-wrap gap-2 mt-2 pl-10">
                <button onclick="sendQuickReply('Je veux un devis')" class="badge badge-outline badge-primary hover:bg-primary hover:text-white cursor-pointer transition-colors p-3">üí∂ Demander un devis</button>
                <button onclick="sendQuickReply('Vos services ?')" class="badge badge-outline badge-secondary hover:bg-secondary hover:text-white cursor-pointer transition-colors p-3">üõ† Nos services</button>
                <button onclick="sendQuickReply('Voir vos r√©alisations')" class="badge badge-outline badge-info hover:bg-info hover:text-white cursor-pointer transition-colors p-3">üé® Nos r√©alisations</button>
                <button onclick="sendQuickReply('Parler √† un humain')" class="badge badge-outline badge-accent hover:bg-accent hover:text-white cursor-pointer transition-colors p-3">üë§ Contact Humain</button>
            </div>

        </div>

        {# Zone de Saisie #}
        <div class="p-3 border-t border-base-content/10 bg-base-100">
            <form onsubmit="sendMessage(event)" class="flex gap-2">
                <input type="text" id="chat-input" placeholder="√âcrivez votre message..." class="input input-bordered input-sm w-full focus:outline-none focus:border-primary rounded-full" autocomplete="off">
                <button type="submit" class="btn btn-primary btn-sm btn-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

            {# CONFIGURATION DES SERVICES  #}
            {# On g√©n√®re l'URL de base avec un "placeholder" qu'on remplacera par le vrai slug en JS #}
<script>
    const baseUrl = "{{ path('app_prestation_show', {'slug': 'PLACEHOLDER'}) }}";
    
    // Liste tes services ici (doit correspondre √† ta BDD)
    const servicesConfig = [
        {
            slug: 'site-vitrine', 
            name: 'Site Vitrine',
            keywords: ['vitrine', 'pr√©sentation', 'site web', 'internet']
        },
        {
            slug: 'e-commerce', 
            name: 'E-Commerce',
            keywords: ['boutique', 'vente', 'ligne', 'shop', 'commerce']
        },
        {
            slug: 'application-mobile', 
            name: 'App Mobile',
            keywords: ['mobile', 'app', 'android', 'ios', 'smartphone']
        }
    ];

    function toggleChat() {
        const chatWindow = document.getElementById('chat-window');
        if (chatWindow.classList.contains('scale-0')) {
            chatWindow.classList.remove('scale-0');
            chatWindow.classList.add('scale-100');
        } else {
            chatWindow.classList.remove('scale-100');
            chatWindow.classList.add('scale-0');
        }
    }

    function sendMessage(event) {
        event.preventDefault();
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (message) {
            addMessage(message, 'end'); // Message utilisateur
            input.value = '';

            // 1. On montre que le robot r√©fl√©chit
            setTimeout(() => {
                showTypingIndicator();
            }, 500);

            // 2. On analyse et on r√©pond
            setTimeout(() => {
                removeTypingIndicator();
                
                // C'est ICI qu'on appelle la nouvelle fonction cerveau
                const smartResponse = analyzeMessage(message);
                
                addMessage(smartResponse.text, 'start');
                
                // Si le robot propose un lien (devis, service, etc.), on affiche le bouton
                if (smartResponse.link) {
                    addLinkButton(smartResponse.link.label, smartResponse.link.url);
                }
            }, 1500);
        }
    }

    function sendQuickReply(text) {
        addMessage(text, 'end');
        setTimeout(() => showTypingIndicator(), 500);
        setTimeout(() => {
            removeTypingIndicator();
            
            // M√™me chose pour les r√©ponses rapides, on passe par le cerveau
            const smartResponse = analyzeMessage(text);
            
            addMessage(smartResponse.text, 'start');
            if (smartResponse.link) {
                addLinkButton(smartResponse.link.label, smartResponse.link.url);
            }
        }, 1000);
    }

    // --- LE CERVEAU DU ROBOT (La fameuse fonction manquante) ---
    function analyzeMessage(message) {
        const lowerMsg = message.toLowerCase();

        // 1. D√âTECTION DES SERVICES
        for (const service of servicesConfig) {
            if (service.keywords.some(keyword => lowerMsg.includes(keyword))) {
                const finalUrl = baseUrl.replace('PLACEHOLDER', service.slug);
                return {
                    text: `Cela ressemble √† un besoin pour notre service **${service.name}**. Souhaitez-vous voir les d√©tails ?`,
                    link: { label: `Voir l'offre ${service.name}`, url: finalUrl }
                };
            }
        }

        // AJOUT : LE MENU G√âN√âRAL (Mot-cl√© "services")
        if (lowerMsg.includes('service') || lowerMsg.includes('prestation') || lowerMsg.includes('offre')) {
            return {
                text: "Nous avons 3 expertises principales : Site Vitrine, E-Commerce et Application Mobile. Souhaitez-vous voir la liste compl√®te ?",
                link: { label: "Voir tous nos services", url: "{{ path('app_prestation_index') }}" }
            };
        }

        // 2. LE COMMERCIAL (Prix / Devis)
        if (lowerMsg.includes('prix') || lowerMsg.includes('tarif') || lowerMsg.includes('co√ªt') || lowerMsg.includes('combien') || lowerMsg.includes('devis') || lowerMsg.includes('argent')) {
            return {
                text: "Chaque projet est unique ! Pour obtenir une estimation pr√©cise (et gratuite), le mieux est de m'en dire un peu plus via le formulaire.",
                link: { label: "Demander un devis", url: "{{ path('app_contact') }}" }
            };
        }

        // 3. LE GUIDE (Portfolio / R√©alisations)
        if (lowerMsg.includes('r√©alisations') || lowerMsg.includes('exemples') || lowerMsg.includes('voir') || lowerMsg.includes('portfolio') || lowerMsg.includes('projet')) {
            return {
                text: "Une image vaut mille mots ! J'ai rassembl√© mes meilleures cr√©ations sur cette page.",
                // Assure-toi d'avoir une section avec id="realisations" sur ta page d'accueil
                link: { label: "Voir le Portfolio", url: "{{ path('app_realisation_index') }}" }
            };
        }

        // 4. L'EXPERT TECH (Symfony vs WordPress)
        if (lowerMsg.includes('wordpress') || lowerMsg.includes('wix') || lowerMsg.includes('shopify') || lowerMsg.includes('cms')) {
            return {
                text: "Chez Cr√©a'Tech, je code sur mesure avec **Symfony**. C'est beaucoup plus rapide, s√©curis√© et √©volutif que des solutions comme WordPress ou Wix."
            };
        }

        // 5. LE FILTRE RH (Stage / Emploi)
        if (lowerMsg.includes('stage') || lowerMsg.includes('stagiaire') || lowerMsg.includes('job') || lowerMsg.includes('alternance') || lowerMsg.includes('recrutement') || lowerMsg.includes('embauche')) {
            return {
                text: "C'est flatteur ! Je travaille actuellement en mode freelance. Vous pouvez tout de m√™me envoyer votre CV via le contact pour mes archives."
            };
        }

        // 6. MESSAGES G√âN√âRIQUES (Politesse)
        if (lowerMsg.includes('bonjour') || lowerMsg.includes('salut') || lowerMsg.includes('hello')) {
            return { text: "Bonjour ! üëã Je suis SPARK, l'intelligence artificielle de Cr√©a'Tech. Comment puis-je booster votre projet aujourd'hui ?" };
        }
        
        if (lowerMsg.includes('humain') || lowerMsg.includes('personne') || lowerMsg.includes('vincent')) {
            return { 
                    text: "Je transmets le message √† Vincent imm√©diatement ! Passez par le formulaire pour une r√©ponse rapide.",
                    link: { label: "Contacter Vincent", url: "{{ path('app_contact') }}" }
            };
        }

        // 7. R√âPONSE PAR D√âFAUT
        return { text: "Je suis encore en apprentissage üß†. Pour cette question sp√©cifique, je vous conseille d'√©crire directement √† Vincent." };
    }

    function addMessage(text, position) {
        const messagesDiv = document.getElementById('chat-messages');
        const bubbleColor = position === 'end' ? 'chat-bubble-secondary' : 'chat-bubble-primary';
        const avatar = position === 'start' ? `<div class="chat-image avatar"><div class="w-8 rounded-full"><img src="{{ asset('img/robot.jpg.png') }}" /></div></div>` : '';
        
        // Conversion du gras Markdown **texte** en HTML <b>texte</b>
        const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

        const html = `
            <div class="chat chat-${position} animate-fade-in-up">
                ${avatar}
                <div class="chat-bubble ${bubbleColor} text-sm shadow-md">${formattedText}</div>
            </div>
        `;
        messagesDiv.insertAdjacentHTML('beforeend', html);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Nouvelle fonction pour ajouter les boutons (Devis, Voir le service, etc.)
    function addLinkButton(label, url) {
        const messagesDiv = document.getElementById('chat-messages');
        const html = `
            <div class="chat chat-start animate-fade-in-up">
                <div class="chat-image avatar invisible"><div class="w-8"></div></div>
                <a href="${url}" class="btn btn-sm btn-accent text-white mt-1 shadow-lg border-2 border-white/20">
                    ${label} 
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 ml-1"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" /></svg>
                </a>
            </div>
        `;
        messagesDiv.insertAdjacentHTML('beforeend', html);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTypingIndicator() {
        const messagesDiv = document.getElementById('chat-messages');
        const html = `
            <div id="typing-indicator" class="chat chat-start">
                <div class="chat-image avatar"><div class="w-8 rounded-full"><img src="{{ asset('img/robot.jpg.png') }}" /></div></div>
                <div class="chat-bubble chat-bubble-primary text-sm shadow-md flex gap-1 items-center h-10">
                    <span class="loading loading-dots loading-xs"></span>
                </div>
            </div>
        `;
        messagesDiv.insertAdjacentHTML('beforeend', html);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }
</script>  

<style>
    /* Petite animation d'apparition des messages */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up {
        animation: fadeInUp 0.3s ease-out forwards;
    }
</style>